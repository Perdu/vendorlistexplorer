<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Various stats</title>
    <link rel=stylesheet type=text/css href="/static/style.css">
    <script type="text/javascript" src="/static/jquery.min.js"></script>
    <style>
      table, th {
      border: 1px solid black;
      }
    </style>
  </head>
  <body>
    {# include 'form.html' #}
    <script src="/static/Chart.js"></script>
    <form action="" method="get">
      <select name="id" id="id">
        {{ select_options|safe }}
      </select>
      <input type="submit" value="Display">
    </form>
    <h1>Used purposes in vendorlist {{ vendorlist_id|safe }}</h1>
    <canvas id="container" height="100px"></canvas>
    <script type="text/javascript">
      window.chartColors = {
	  red: 'rgb(255, 99, 132)',
	  orange: 'rgb(255, 159, 64)',
	  yellow: 'rgb(255, 205, 86)',
	  green: 'rgb(75, 192, 92)',
	  blue: 'rgb(54, 162, 235)',
	  purple: 'rgb(153, 102, 255)',
	  grey: 'rgb(231,233,237)'
      };
      var canvas = document.getElementById('container');
      var ctx = canvas.getContext('2d');
      var myChart = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: [
                  'Store and/or access information on a device',
                  'Select basic ads',
                  'Create a personalised ads profile',
                  'Select personalised ads',
                  'Create a personalised content profile',
                  'Select personalised content',
                  'Measure ad performance',
                  'Measure content performance',
                  'Apply market research to generate audience insights',
                  'Develop and improve product'
              ],
              datasets: [
                  {
                      label: 'Consent',
                      data: [{{ purpose_series|safe }}],
                      backgroundColor: window.chartColors.blue
                  },
                  {
                      label: 'Legitimate interest',
                      data: [{{ legint_series|safe }}],
                      backgroundColor: window.chartColors.red
                  },
                  {
                      label: 'Flexible purpose',
                      data: [{{ flexible_series|safe }}],
                      backgroundColor: window.chartColors.green
                  }
              ]
          },
          options: {
              responsive: true,
              scales: {
                  xAxes: [{
		      //stacked: true,
		  }],
                  yAxes: [{
                      //stacked: true
                  }]
              },
              tooltips: {
		  mode: 'nearest',
		  intersect: true
	      },
              onClick: function(e) {
                  var bar = this.getElementAtEvent(e)[0];
                  var index = bar._index;
                  var datasetIndex = bar._datasetIndex;
                  var purpose = index + 1;
                  $.ajax({
                      url: "vendors?vendorlistid={{ vendorlist_id }}&consentpurposeid=" + purpose + "&categ=" + datasetIndex,
                      type: "GET",
                      dataType : "json",
                      success: function(ans) {
                          $("#vendors_table").find("tr:gt(0)").remove(); // empty table except first row
                          ans.forEach(function(item, index) {
                              link = encodeURI(item[1]);
                              cookieMaxAge = encodeURI(item[2]);
                              usesNonCookieAccess = item[3] == 1 ? 'yes' : 'no';
                              $("#vendors_table").append($('<tr>')
                                                         .append($('<td>').append(item[0]))
                                                         .append($('<td>').html('<a href="' + link + '">' + link + '</a>'))
                                                         .append($('<td>').append(cookieMaxAge))
                                                         .append($('<td>').append(usesNonCookieAccess))
                                                        );
                          }
                                     );
                      },
                  });
              }
          }
      });
    </script>
    <br />
    Click on bars to display vendors!
    <table id="vendors_table">
      <tr>
        <td>Name</td>
        <td>Policy URL</td>
        <td>Cookie max age (seconds)</td>
        <td>Uses non-cookie storage</td>
      </tr>
    </table>
    {# include 'source.html' #}
  </body>
</html>
